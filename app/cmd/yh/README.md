# ヤフー社内でやってるMySQLチューニングセミナー大公開 
[ヤフー社内でやってるMySQLチューニングセミナー大公開 ](https://www.slideshare.net/techblogyahoo/mysql-58540246)  

## type=ALL または type=indexでrowsが大きい
![image](https://image.slidesharecdn.com/mysqlsqltuningseminormynajpug201602-160222054211/95/mysql-32-638.jpg?cb=1456119774)

## 配信情報(push_info)から削除済み(deleted=1)かつ更新日(mod_date)が180日よりまえのデータを抽出する

``` sql
# NG SQL
mysql> EXPLAIN SELECT COUNT(push_id) FROM yh_push_info WHERE deleted_flg = 1 AND DATEDIFF(NOW(), mod_date) > '180';
+----+-------------+--------------+------------+------+---------------+------+---------+------+--------+----------+-------------+
| id | select_type | table        | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+--------------+------------+------+---------------+------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | yh_push_info | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 998842 |    10.00 | Using where |
+----+-------------+--------------+------------+------+---------------+------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.01 sec)
```

``` sql
# index追加
ALTER TABLE yh_push_info ADD INDEX idx_deleted_flg_mod_date (deleted_flg, mod_date);
```

``` sql
# index追加
mysql> EXPLAIN SELECT push_id FROM yh_push_info WHERE deleted_flg = 1 AND DATEDIFF(NOW(), mod_date) > '180';
+----+-------------+--------------+------------+------+--------------------------+--------------------------+---------+-------+--------+----------+--------------------------+
| id | select_type | table        | partitions | type | possible_keys            | key                      | key_len | ref   | rows   | filtered | Extra                    |
+----+-------------+--------------+------------+------+--------------------------+--------------------------+---------+-------+--------+----------+--------------------------+
|  1 | SIMPLE      | yh_push_info | NULL       | ref  | idx_deleted_flg_mod_date | idx_deleted_flg_mod_date | 1       | const | 499421 |   100.00 | Using where; Using index |
+----+-------------+--------------+------------+------+--------------------------+--------------------------+---------+-------+--------+----------+--------------------------+
1 row in set, 1 warning (0.00 sec)

mysql> EXPLAIN ANALYZE SELECT push_id FROM yh_push_info WHERE deleted_flg = 1 AND DATEDIFF(NOW(), mod_date) > '180';
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN

                                                        |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: ((<cache>(to_days(now())) - to_days(yh_push_info.mod_date)) > '180')  (cost=50552.15 rows=499421) (actual time=0.053..185.052 rows=665867 loops=1)
    -> Index lookup on yh_push_info using idx_deleted_flg_mod_date (deleted_flg=1)  (cost=50552.15 rows=499421) (actual time=0.032..122.563 rows=899739 loops=1)
 |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.22 sec)
```

typeがALLからref(pk or unique key以外のインデックス)使うようになった。  
ただし、INDEXはdeleted_flgしか使えてない。
Index lookupによりINDEXからテーブル見に行ってる。
そのあとにFilterしている。  
mod_dateに関数を使わないことでINDEXを使えるようになる。  

``` sql
mysql> EXPLAIN SELECT push_id FROM yh_push_info WHERE deleted_flg = 1 AND mod_date < date_sub(NOW(),INTERVAL 180 DAY);
+----+-------------+--------------+------------+-------+--------------------------+--------------------------+---------+------+--------+----------+--------------------------+
| id | select_type | table        | partitions | type  | possible_keys            | key                      | key_len | ref  | rows   | filtered | Extra                    |
+----+-------------+--------------+------------+-------+--------------------------+--------------------------+---------+------+--------+----------+--------------------------+
|  1 | SIMPLE      | yh_push_info | NULL       | range | idx_deleted_flg_mod_date | idx_deleted_flg_mod_date | 6       | NULL | 499421 |   100.00 | Using where; Using index |
+----+-------------+--------------+------------+-------+--------------------------+--------------------------+---------+------+--------+----------+--------------------------+
1 row in set, 1 warning (0.00 sec)

EXPLAIN ANALYZE SELECT push_id FROM yh_push_info WHERE deleted_flg = 1 AND mod_date < date_sub(NOW(),INTERVAL 180 DAY);
mysql> EXPLAIN ANALYZE SELECT push_id FROM yh_push_info WHERE deleted_flg = 1 AND mod_date < date_sub(NOW(),INTERVAL 180 DAY);
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN

                                                                            |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: ((yh_push_info.deleted_flg = 1) and (yh_push_info.mod_date < <cache>((now() - interval 180 day))))  (cost=100494.26 rows=499421) (actual time=0.023..151.652 rows=667116 loops=1)
    -> Index range scan on yh_push_info using idx_deleted_flg_mod_date  (cost=100494.26 rows=499421) (actual time=0.020..105.133 rows=667116 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.18 sec)
```

typeがrange(indexを使った範囲検索)になる。  
Index range scanになってINDEXで完結してる。  
